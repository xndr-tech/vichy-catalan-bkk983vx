# LEVR Preview Workflow v1.2.0
# Generated by LEVR CMS v0.5.3
name: Preview Deploy

on:
  push:
    branches-ignore: [main]
  pull_request:
    branches: [main]

env:
  SITE_NAME: Vichy Catalan

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      is_valid: ${{ steps.validate.outputs.valid }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate HTML
        id: validate
        run: |
          HTML_FILE="public/index.html"
          if [ ! -f "$HTML_FILE" ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          if ! grep -q '</html>' "$HTML_FILE"; then
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "valid=true" >> $GITHUB_OUTPUT

  deploy-preview:
    needs: validate
    if: needs.validate.outputs.is_valid == 'true'
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.deployment-url }}
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm install --prefer-offline --no-audit
      - uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          command: deploy --env preview
      - if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.deployment-url }}';
            if (url) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: 'ðŸ” **Preview:** ' + url + '\n\nBranch: `${{ github.ref_name }}`'
              });
            }
      - run: |
          echo "### ðŸ” Preview Deployed" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
